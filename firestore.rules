rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is a validated caregiver for a given patient
    function isCaregiver(patientId, request) {
      return exists(/databases/$(database)/documents/users/$(patientId)/caregivers/$(request.auth.uid));
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Users can only read and write to their own user document
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Rules for the 'medicines' subcollection
      match /medicines/{medicineId} {
        // A user can manage their own medicines
        allow read, write, delete: if request.auth != null && request.auth.uid == userId;
        // A validated caregiver can read the patient's medicines
        allow get, list: if request.auth != null && isCaregiver(userId, request);
      }

      // Rules for the 'medicine_logs' subcollection
      match /medicine_logs/{logId} {
        // A user can read their own medicine logs
        allow read: if request.auth != null && request.auth.uid == userId;
        // A user or a validated caregiver can create a log for the patient
        allow create: if request.auth != null && (request.auth.uid == userId || isCaregiver(userId, request));
      }

      // Rules for the 'caregivers' subcollection, which stores accepted caregivers
      match /caregivers/{caregiverId} {
        // Only the patient can see who their caregivers are
        allow read, list: if request.auth != null && request.auth.uid == userId;
        // A patient can add/remove caregivers. A caregiver is added here when they accept an invitation.
        allow write, delete: if request.auth != null && (request.auth.uid == userId || request.auth.uid == caregiverId);
      }
    }

    // Rules for the 'invitations' collection
    match /invitations/{invitationId} {
      // The patient who owns the data can create an invitation
      allow create: if request.auth != null && request.resource.data.patientId == request.auth.uid;

      // The invited caregiver can read the invitation to see who sent it
      allow read: if request.auth != null && request.resource.data.caregiverEmail == request.auth.token.email;

      // The invited caregiver can update the status to 'accepted' or 'declined'
      allow update: if request.auth != null &&
                       request.resource.data.caregiverEmail == request.auth.token.email &&
                       (request.resource.data.status == 'accepted' || request.resource.data.status == 'declined');

      // The patient who sent the invitation can delete/cancel it
      allow delete: if request.auth != null && get(/databases/$(database)/documents/invitations/$(invitationId)).data.patientId == request.auth.uid;
    }
  }
}